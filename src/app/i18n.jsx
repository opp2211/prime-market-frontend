/* eslint-disable react-refresh/only-export-components */
import { createContext, useContext, useEffect, useMemo, useState } from 'react'
import { readLocalStorage, writeLocalStorage } from '../shared/lib/storage'

const LANG_KEY = 'pm_lang'
const SUPPORTED_LANGS = ['ru', 'en']

const messages = {
  ru: {
    brand: {
      subtitle: 'Биржа игровых активов и цифровых товаров',
      aria: 'Prime Market — на главную',
    },
    header: {
      themeToggle: 'Переключить тему',
      themeLight: 'Светлая',
      themeDark: 'Тёмная',
      languageTitle: 'Язык',
      languageAria: 'Выбор языка',
      openMenu: 'Открыть меню',
      menuTitle: 'Аккаунт',
      menuProfile: 'Мой профиль',
      menuWallet: 'Кошелек',
      menuDepositRequests: 'Мои заявки на пополнение',
      logout: 'Выйти',
      login: 'Войти',
      register: 'Регистрация',
    },
    account: {
      title: 'Аккаунт',
      profileTitle: 'Профиль',
      walletTitle: 'Кошелек',
      username: 'Имя пользователя',
      email: 'Email',
      changeEmail: 'Изменить email',
      changePassword: 'Изменить пароль',
      walletEmpty: 'Ваш кошелек пуст',
      balance: 'Баланс',
      reserved: 'В резерве',
      available: 'Доступно',
      deposit: 'Пополнить',
      withdraw: 'Вывести',
      depositTitle: 'Пополнение баланса',
      depositSubtitle:
        'Выберите валюту, способ оплаты и сумму. Для авто-подтверждения деньги зачисляются почти мгновенно.',
      depositStepCurrency: 'Валюта',
      depositStepCurrencyHint: 'Выберите валюту пополнения.',
      depositStepMethod: 'Метод оплаты',
      depositStepMethodHint: 'Авто или ручное подтверждение.',
      depositStepAmount: 'Сумма',
      depositStepAmountHint: 'Введите сумму и продолжайте.',
      depositCurrencyTitle: 'Выбор валюты',
      depositCurrencyLabel: 'Валюта',
      depositCurrencyPlaceholder: 'Выберите валюту',
      depositCurrencyHint: 'Список доступных валют подгружается из вашего аккаунта.',
      depositCurrenciesError: 'Не удалось загрузить список валют.',
      depositMethodTitle: 'Методы оплаты',
      depositMethodHint: 'Способ зависит от выбранной валюты.',
      depositMethodEmpty: 'Нет доступных методов оплаты.',
      depositMethodsError: 'Не удалось загрузить методы оплаты.',
      depositMethodAutoHint: 'Почти мгновенное зачисление.',
      depositMethodManualHint: 'Потребуется подтверждение оператора.',
      depositManualTag: 'Ручное подтверждение',
      depositAutoTag: 'Авто-подтверждение',
      depositManualHighlight: 'Ручное подтверждение',
      depositAutoHighlight: 'Авто-подтверждение',
      depositManualHelp:
        'Депозит будет подтвержден после того как оператор вручную обработает вашу заявку.',
      depositAutoHelp: 'Депозит будет подтвержден системой автоматически.',
      depositAmountTitle: 'Сумма',
      depositAmountLabel: 'Сумма пополнения',
      depositAmountPlaceholder: 'Введите сумму',
      depositAmountHint: 'Укажите сумму в выбранной валюте.',
      depositContinue: 'Продолжить',
      depositCreating: 'Создаем заявку...',
      depositMethodRequired: 'Выберите метод оплаты.',
      depositAmountInvalid: 'Введите корректную сумму.',
      depositRequestError: 'Не удалось создать заявку на пополнение.',
      depositRequestActionError: 'Не удалось обновить заявку.',
      depositRequestInvalid: 'Сервер вернул некорректный ответ.',
      depositRequestsTitle: 'Мои заявки на пополнение',
      depositRequestsEmpty: 'Заявок на пополнение пока нет.',
      depositRequestsError: 'Не удалось загрузить заявки на пополнение.',
      depositRequestTitle: 'Заявка на пополнение',
      depositRequestOpen: 'Открыть',
      depositRequestLoadError: 'Не удалось загрузить заявку.',
      depositRequestBack: 'К списку заявок',
      depositRequestMarkPaid: 'Оплачено',
      depositRequestCancel: 'Отменить',
      depositRequestPaymentDetails: 'Реквизиты',
      depositRequestRejectReason: 'Причина отказа',
      depositRequestIdLabel: 'ID заявки',
      depositRequestMethodLabel: 'Метод оплаты',
      depositRequestStatusLabel: 'Статус',
      depositRequestCreatedAt: 'Создано',
      depositRequestDetailsIssuedAt: 'Реквизиты выданы',
      depositRequestMarkedPaidAt: 'Оплачено пользователем',
      depositRequestConfirmedAt: 'Подтверждено',
      depositRequestRejectedAt: 'Отклонено',
      depositRequestCancelledAt: 'Отменено',
      depositStatusPendingDetails: 'Ожидает реквизитов',
      depositStatusWaitingPayment: 'Ожидает оплаты',
      depositStatusPaymentVerification: 'Проверка оплаты',
      depositStatusConfirmed: 'Подтверждено',
      depositStatusRejected: 'Отклонено',
      depositStatusCancelled: 'Отменено',
      depositStatusUnknown: 'Неизвестно',
      notAvailable: '—',
      depositInfoTitle: 'Что делать дальше',
      depositInfoPendingDetails:
        'Пожалуйста ожидайте пока оператор предоставит вам реквизиты для оплаты.',
      depositInfoWaitingPayment:
        'Пожалуйста, совершите оплату по указанным реквизитам. Будьте внимательны: при отправке денег на другие реквизиты средства могут быть утрачены.',
      depositInfoPaymentVerification:
        'Оплата отмечена. Ожидайте подтверждения оператора.',
      depositInfoConfirmed: 'Пополнение подтверждено. Средства скоро будут доступны.',
      depositInfoRejected: 'Заявка на пополнение была отклонена.',
      depositInfoRejectedReason: 'Причина',
      depositInfoCancelled: 'Заявка на пополнение была отменена.',
      depositInfoDefault: 'Следуйте инструкциям по заявке.',
      depositCopy: 'Скопировать',
      depositCopyAllDetails: 'Скопировать реквизиты',
      depositCopyId: 'Скопировать ID заявки',
      depositDetailsPending: 'Ожидание реквизитов',
      loading: 'Загрузка...',
      profileError: 'Не удалось загрузить профиль.',
      walletError: 'Не удалось загрузить кошелек.',
    },
    home: {
      eyebrow: 'Площадка для игровых активов',
      title: 'Prime Market — современный маркетплейс цифровых товаров',
      description:
        'Покупайте и продавайте игровые предметы, аккаунты и услуги в одном месте. Понятный интерфейс, быстрый старт и прозрачные условия.',
      ctaPrimary: 'Создать аккаунт',
      ctaSecondary: 'Войти',
      pillOne: 'Простое размещение лотов',
      pillTwo: 'Сделки без лишних шагов',
      pillThree: 'Понятные комиссии',
      sectionTitle: 'Как это работает',
      sectionSubtitle: 'Три простых шага, чтобы начать работу на площадке.',
      stepOneTitle: 'Создайте аккаунт',
      stepOneText: 'Заполните профиль и добавьте основные данные для связи.',
      stepTwoTitle: 'Опубликуйте лот',
      stepTwoText: 'Добавьте описание, цену и формат сделки, чтобы вас нашли покупатели.',
      stepThreeTitle: 'Договоритесь о сделке',
      stepThreeText: 'Обсудите детали и завершите покупку на удобных условиях.',
    },
    login: {
      title: 'Вход',
      emailLabel: 'Email',
      emailPlaceholder: 'Введите email',
      emailRequired: 'Введите email.',
      emailInvalid: 'Некорректный формат email.',
      passwordLabel: 'Пароль',
      passwordPlaceholder: 'Введите пароль',
      passwordRequired: 'Введите пароль.',
      submit: 'Войти',
      submitting: 'Входим...',
      divider: 'или',
      oauthGoogle: 'Продолжить с Google',
      oauthDiscord: 'Продолжить с Discord',
      noAccount: 'Нет аккаунта?',
      registerLink: 'Зарегистрироваться',
      invalidCredentials: 'Неверный email или пароль.',
      errorFallback: 'Не удалось войти. Проверьте email и пароль.',
      emailNotVerified: 'Подтвердите email, чтобы войти.',
      resendVerification: 'Отправить письмо еще раз',
      resendSending: 'Отправляем...',
      resendSent: 'Письмо отправлено. Проверьте почту.',
      resendError: 'Не удалось отправить письмо.',
      resendMissingEmail: 'Введите email, чтобы отправить письмо.',
    },
    register: {
      title: 'Регистрация',
      usernameLabel: 'Имя пользователя',
      usernamePlaceholder: 'Введите имя пользователя',
      usernameRequired: 'Введите имя пользователя.',
      usernameLength: 'Имя пользователя должно быть от 3 до 24 символов.',
      emailLabel: 'Email',
      emailPlaceholder: 'Введите email',
      emailRequired: 'Введите email.',
      emailInvalid: 'Некорректный формат email.',
      passwordLabel: 'Пароль',
      passwordPlaceholder: 'Введите пароль',
      passwordRequired: 'Введите пароль.',
      passwordConfirmLabel: 'Повторите пароль',
      passwordConfirmPlaceholder: 'Повторите пароль',
      passwordConfirmRequired: 'Повторите пароль.',
      submit: 'Зарегистрироваться',
      submitting: 'Регистрируем...',
      haveAccount: 'Уже есть аккаунт?',
      loginLink: 'Войти',
      mismatch: 'Пароли не совпадают.',
      errorFallback: 'Не удалось зарегистрироваться. Проверьте данные.',
    },
    checkEmail: {
      title: 'Подтвердите email',
      subtitle: 'Проверьте почту и перейдите по ссылке в письме.',
      subtitleEmail: 'Мы отправили письмо на',
      tip: 'Если письмо не пришло, проверьте спам или отправьте еще раз.',
      resend: 'Отправить еще раз',
      resending: 'Отправляем...',
      resent: 'Письмо отправлено.',
      resentError: 'Не удалось отправить письмо.',
      noEmail: 'Email не найден. Запросите новое письмо со страницы входа.',
      loginLink: 'Войти',
    },
    verifyEmail: {
      title: 'Подтверждение email',
      loading: 'Проверяем ссылку...',
      success: 'Email подтвержден. Вы вошли в систему.',
      errorFallback: 'Не удалось подтвердить email.',
      noToken: 'Некорректная ссылка подтверждения.',
      goHome: 'На главную',
      loginLink: 'Войти',
    },
  },
  en: {
    brand: {
      subtitle: 'Marketplace for gaming assets and digital goods',
      aria: 'Prime Market - home',
    },
    header: {
      themeToggle: 'Toggle theme',
      themeLight: 'Light',
      themeDark: 'Dark',
      languageTitle: 'Language',
      languageAria: 'Language selection',
      openMenu: 'Open menu',
      menuTitle: 'Account',
      menuProfile: 'My profile',
      menuWallet: 'Wallet',
      menuDepositRequests: 'My deposit requests',
      logout: 'Log out',
      login: 'Log in',
      register: 'Sign up',
    },
    account: {
      title: 'Account',
      profileTitle: 'Profile',
      walletTitle: 'Wallet',
      username: 'Username',
      email: 'Email',
      changeEmail: 'Change email',
      changePassword: 'Change password',
      walletEmpty: 'Your wallet is empty',
      balance: 'Balance',
      reserved: 'Reserved',
      available: 'Available',
      deposit: 'Deposit',
      withdraw: 'Withdraw',
      depositTitle: 'Balance top-up',
      depositSubtitle:
        'Choose a currency, payment method, and amount. Auto confirmation credits the balance almost instantly.',
      depositStepCurrency: 'Currency',
      depositStepCurrencyHint: 'Select the top-up currency.',
      depositStepMethod: 'Payment method',
      depositStepMethodHint: 'Auto or manual confirmation.',
      depositStepAmount: 'Amount',
      depositStepAmountHint: 'Enter the amount to continue.',
      depositCurrencyTitle: 'Currency selection',
      depositCurrencyLabel: 'Currency',
      depositCurrencyPlaceholder: 'Select currency',
      depositCurrencyHint: 'The list of available currencies comes from your account.',
      depositCurrenciesError: "Couldn't load currency list.",
      depositMethodTitle: 'Payment methods',
      depositMethodHint: 'Availability depends on the selected currency.',
      depositMethodEmpty: 'No payment methods available.',
      depositMethodsError: "Couldn't load payment methods.",
      depositMethodAutoHint: 'Almost instant crediting.',
      depositMethodManualHint: 'Requires an operator review.',
      depositManualTag: 'Manual confirmation',
      depositAutoTag: 'Auto confirmation',
      depositManualHighlight: 'Manual confirmation',
      depositAutoHighlight: 'Auto confirmation',
      depositManualHelp:
        'Your deposit will be confirmed after an operator manually processes your request.',
      depositAutoHelp: 'Your deposit will be confirmed automatically by the system.',
      depositAmountTitle: 'Amount',
      depositAmountLabel: 'Deposit amount',
      depositAmountPlaceholder: 'Enter amount',
      depositAmountHint: 'Enter the amount in the selected currency.',
      depositContinue: 'Continue',
      depositCreating: 'Creating request...',
      depositMethodRequired: 'Select a payment method.',
      depositAmountInvalid: 'Enter a valid amount.',
      depositRequestError: "Couldn't create a deposit request.",
      depositRequestActionError: "Couldn't update the request.",
      depositRequestInvalid: 'The server returned an invalid response.',
      depositRequestsTitle: 'My deposit requests',
      depositRequestsEmpty: 'No deposit requests yet.',
      depositRequestsError: "Couldn't load deposit requests.",
      depositRequestTitle: 'Deposit request',
      depositRequestOpen: 'Open',
      depositRequestLoadError: "Couldn't load the request.",
      depositRequestBack: 'Back to requests',
      depositRequestMarkPaid: 'Paid',
      depositRequestCancel: 'Cancel',
      depositRequestPaymentDetails: 'Payment details',
      depositRequestRejectReason: 'Rejection reason',
      depositRequestIdLabel: 'Request ID',
      depositRequestMethodLabel: 'Payment method',
      depositRequestStatusLabel: 'Status',
      depositRequestCreatedAt: 'Created at',
      depositRequestDetailsIssuedAt: 'Details issued',
      depositRequestMarkedPaidAt: 'Marked paid',
      depositRequestConfirmedAt: 'Confirmed at',
      depositRequestRejectedAt: 'Rejected at',
      depositRequestCancelledAt: 'Cancelled at',
      depositStatusPendingDetails: 'Pending details',
      depositStatusWaitingPayment: 'Waiting for payment',
      depositStatusPaymentVerification: 'Payment verification',
      depositStatusConfirmed: 'Confirmed',
      depositStatusRejected: 'Rejected',
      depositStatusCancelled: 'Cancelled',
      depositStatusUnknown: 'Unknown',
      notAvailable: '—',
      depositInfoTitle: 'Next steps',
      depositInfoPendingDetails:
        'Please wait while the operator provides payment details.',
      depositInfoWaitingPayment:
        'Please make the payment using the provided details. Be careful: sending money to other details may result in loss of funds.',
      depositInfoPaymentVerification:
        'Payment was marked. Please wait for operator confirmation.',
      depositInfoConfirmed: 'The top-up is confirmed. Funds will be available soon.',
      depositInfoRejected: 'The deposit request was rejected.',
      depositInfoRejectedReason: 'Reason',
      depositInfoCancelled: 'The deposit request was cancelled.',
      depositInfoDefault: 'Follow the instructions for this request.',
      depositCopy: 'Copy',
      depositCopyAllDetails: 'Copy payment details',
      depositCopyId: 'Copy request ID',
      depositDetailsPending: 'Waiting for payment details',
      loading: 'Loading...',
      profileError: "Couldn't load profile.",
      walletError: "Couldn't load wallet.",
    },
    home: {
      eyebrow: 'Marketplace for gaming assets',
      title: 'Prime Market — a modern hub for digital goods',
      description:
        'Buy and sell in-game items, accounts, and services in one place. Clear interface, quick start, and transparent terms.',
      ctaPrimary: 'Create account',
      ctaSecondary: 'Log in',
      pillOne: 'Easy listings',
      pillTwo: 'No extra steps',
      pillThree: 'Clear terms',
      sectionTitle: 'How it works',
      sectionSubtitle: 'Three simple steps to get started on the marketplace.',
      stepOneTitle: 'Create an account',
      stepOneText: 'Set up your profile and add the essentials to get started.',
      stepTwoTitle: 'Publish a listing',
      stepTwoText: 'Add description, price, and deal type so buyers can find you.',
      stepThreeTitle: 'Close the deal',
      stepThreeText: 'Agree on details and complete the transaction on your terms.',
    },
    login: {
      title: 'Log in',
      emailLabel: 'Email',
      emailPlaceholder: 'Enter email',
      emailRequired: 'Enter email.',
      emailInvalid: 'Invalid email format.',
      passwordLabel: 'Password',
      passwordPlaceholder: 'Enter password',
      passwordRequired: 'Enter password.',
      submit: 'Log in',
      submitting: 'Logging in...',
      divider: 'or',
      oauthGoogle: 'Continue with Google',
      oauthDiscord: 'Continue with Discord',
      noAccount: 'No account?',
      registerLink: 'Sign up',
      invalidCredentials: 'Invalid email or password.',
      errorFallback: "Couldn't log in. Check email/password.",
      emailNotVerified: 'Verify your email to log in.',
      resendVerification: 'Send verification email',
      resendSending: 'Sending...',
      resendSent: 'Email sent. Check your inbox.',
      resendError: "Couldn't send email.",
      resendMissingEmail: 'Enter email to send the message.',
    },
    register: {
      title: 'Sign up',
      usernameLabel: 'Username',
      usernamePlaceholder: 'Enter username',
      usernameRequired: 'Enter username.',
      usernameLength: 'Username must be 3 to 24 characters.',
      emailLabel: 'Email',
      emailPlaceholder: 'Enter email',
      emailRequired: 'Enter email.',
      emailInvalid: 'Invalid email format.',
      passwordLabel: 'Password',
      passwordPlaceholder: 'Enter password',
      passwordRequired: 'Enter password.',
      passwordConfirmLabel: 'Confirm password',
      passwordConfirmPlaceholder: 'Confirm password',
      passwordConfirmRequired: 'Confirm password.',
      submit: 'Sign up',
      submitting: 'Signing up...',
      haveAccount: 'Already have an account?',
      loginLink: 'Log in',
      mismatch: 'Passwords do not match.',
      errorFallback: "Couldn't sign up. Check your details.",
    },
    checkEmail: {
      title: 'Verify your email',
      subtitle: 'Check your inbox and follow the link in the email.',
      subtitleEmail: 'We sent an email to',
      tip: "If you didn't receive it, check spam or resend the email.",
      resend: 'Send again',
      resending: 'Sending...',
      resent: 'Email sent.',
      resentError: "Couldn't send email.",
      noEmail: 'No email found. Request a new email from the login page.',
      loginLink: 'Log in',
    },
    verifyEmail: {
      title: 'Email verification',
      loading: 'Verifying your link...',
      success: 'Email verified. You are now logged in.',
      errorFallback: "Couldn't verify email.",
      noToken: 'Invalid verification link.',
      goHome: 'Go to home',
      loginLink: 'Log in',
    },
  },
}

function resolvePath(obj, path) {
  const parts = path.split('.')
  let current = obj
  for (const part of parts) {
    if (!current || typeof current !== 'object') return null
    current = current[part]
  }
  return current
}

function getInitialLanguage() {
  if (typeof window === 'undefined') return 'ru'
  const stored = readLocalStorage(LANG_KEY)
  if (SUPPORTED_LANGS.includes(stored)) return stored
  const navLang = (navigator?.language || '').toLowerCase()
  return navLang.startsWith('en') ? 'en' : 'ru'
}

function applyLanguage(next) {
  if (typeof document !== 'undefined') {
    document.documentElement.lang = next
  }
  writeLocalStorage(LANG_KEY, next)
}

const I18nContext = createContext({
  language: 'ru',
  setLanguage: () => {},
  t: (key) => key,
})

export function I18nProvider({ children }) {
  const [language, setLanguageState] = useState(getInitialLanguage)

  useEffect(() => {
    applyLanguage(language)
  }, [language])

  const value = useMemo(() => {
    const t = (key) => {
      const langPack = messages[language] || messages.ru
      const resolved = resolvePath(langPack, key)
      return resolved == null ? key : resolved
    }

    const setLanguage = (next) => {
      if (!SUPPORTED_LANGS.includes(next)) return
      setLanguageState(next)
    }

    return { language, setLanguage, t }
  }, [language])

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>
}

export function useI18n() {
  return useContext(I18nContext)
}
